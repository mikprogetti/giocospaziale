<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Space Bitcoin Mission</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background: linear-gradient(to bottom, #0a0a2a, #1a1a4a);
            color: white;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 10px;
        }
        
        #game-container {
            position: relative;
            width: min(95vw, 800px);
            height: min(80vh, 600px);
            border: 2px solid #4a9eff;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.5);
        }
        
        #game-canvas {
            background: radial-gradient(circle at center, #0a0a2a, #000011);
            display: block;
            width: 100%;
            height: 100%;
        }
        
        #ui-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 8px;
            display: flex;
            justify-content: space-between;
            pointer-events: none;
            font-size: min(2.5vw, 16px);
        }
        
        .ui-panel {
            background: rgba(10, 10, 42, 0.8);
            padding: 6px 10px;
            border-radius: 5px;
            border: 1px solid #4a9eff;
            margin: 0 2px;
        }
        
        #level-indicator {
            font-weight: bold;
            color: #4a9eff;
        }
        
        #score-display {
            font-weight: bold;
            color: #ffcc00;
        }
        
        #special-weapon {
            font-weight: bold;
            color: #ff5500;
        }
        
        #combo-display {
            font-weight: bold;
            color: #ff00cc;
        }
        
        #bitcoin-display {
            font-weight: bold;
            color: #FF9900;
        }
        
        #start-screen, #level-complete, #game-over, #mission-screen, #ship-select-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 20, 0.9);
            z-index: 10;
            padding: 15px;
            text-align: center;
        }
        
        #level-complete, #game-over, #mission-screen, #ship-select-screen {
            display: none;
        }
        
        h1 {
            font-size: min(8vw, 48px);
            margin-bottom: 15px;
            color: #4a9eff;
            text-shadow: 0 0 10px rgba(74, 158, 255, 0.7);
        }
        
        h2 {
            font-size: min(6vw, 36px);
            margin-bottom: 15px;
            color: #ffcc00;
        }
        
        p {
            font-size: min(4vw, 18px);
            margin-bottom: 15px;
            text-align: center;
            max-width: 90%;
            line-height: 1.5;
        }
        
        .btn {
            background: linear-gradient(to bottom, #4a9eff, #2a5aaa);
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: min(4vw, 18px);
            border-radius: 30px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 0 15px rgba(74, 158, 255, 0.5);
            margin: 5px;
            min-width: 140px;
        }
        
        .btn:hover {
            background: linear-gradient(to bottom, #5aaeff, #3a6aba);
            transform: scale(1.05);
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.7);
        }
        
        .btn-ship {
            background: linear-gradient(to bottom, #ffcc00, #ff8800);
        }
        
        .btn-ship:hover {
            background: linear-gradient(to bottom, #ffdd44, #ffaa44);
        }
        
        .controls-info {
            margin-top: 15px;
            background: rgba(74, 158, 255, 0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
        }
        
        .controls-info h3 {
            margin-bottom: 8px;
            color: #ffcc00;
            font-size: min(4vw, 18px);
        }
        
        .upgrade-info {
            margin-top: 12px;
            background: rgba(255, 204, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            text-align: center;
            max-width: 90%;
        }
        
        .upgrade-info h3 {
            color: #ffcc00;
            margin-bottom: 5px;
            font-size: min(4vw, 18px);
        }
        
        .ship-evolution {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .ship-stage {
            text-align: center;
            margin: 0 5px;
        }
        
        .ship-stage.active {
            transform: scale(1.1);
        }
        
        .ship-icon {
            width: 40px;
            height: 50px;
            margin: 0 auto 5px;
            background: linear-gradient(to bottom, #4a9eff, #2a5aaa);
            clip-path: polygon(50% 0%, 100% 30%, 80% 100%, 20% 100%, 0% 30%);
        }
        
        .ship-stage.active .ship-icon {
            background: linear-gradient(to bottom, #ffcc00, #ff8800);
            box-shadow: 0 0 15px rgba(255, 204, 0, 0.7);
        }
        
        .power-up-indicator {
            position: absolute;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 255, 0, 0.7);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 5;
        }
        
        .mission-info {
            background: rgba(255, 204, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 8px 0;
            text-align: center;
            max-width: 90%;
        }
        
        .achievement-popup {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffcc00;
            text-align: center;
            z-index: 100;
            display: none;
            max-width: 80%;
        }
        
        .ship-option {
            display: inline-block;
            margin: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            padding: 8px;
        }
        
        .ship-option:hover {
            transform: scale(1.05);
        }
        
        .ship-option.selected {
            border: 2px solid #ffcc00;
            border-radius: 10px;
            padding: 8px;
        }
        
        .ship-preview {
            width: 50px;
            height: 70px;
            margin: 0 auto 5px;
            background: linear-gradient(to bottom, #4a9eff, #2a5aaa);
            clip-path: polygon(50% 0%, 100% 30%, 80% 100%, 20% 100%, 0% 30%);
        }
        
        .ship-speedster .ship-preview {
            background: linear-gradient(to bottom, #00ffcc, #00aa88);
        }
        
        .ship-tank .ship-preview {
            background: linear-gradient(to bottom, #ff5555, #aa2222);
        }
        
        .ship-sniper .ship-preview {
            background: linear-gradient(to bottom, #cc00ff, #8800aa);
        }
        
        #debug-info {
            position: absolute;
            bottom: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px;
            border-radius: 5px;
            font-size: 10px;
            display: none;
        }
        
        .bitcoin-indicator {
            position: absolute;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 153, 0, 0.7);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            display: none;
            z-index: 5;
        }

        .evolution-notification {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            border: 2px solid #ffcc00;
            text-align: center;
            z-index: 90;
            display: none;
            max-width: 80%;
        }

        .bitcoin-summary {
            background: rgba(255, 153, 0, 0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 10px 0;
        }

        @media (max-height: 700px) {
            #game-container {
                height: 90vh;
            }
            
            .btn {
                padding: 8px 16px;
                min-width: 120px;
            }
        }

        @media (max-width: 600px) {
            #ui-overlay {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .ui-panel {
                margin: 2px;
                padding: 4px 8px;
            }
            
            .ship-option {
                margin: 5px;
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <canvas id="game-canvas"></canvas>
        
        <div id="ui-overlay">
            <div class="ui-panel">
                <div id="level-indicator">LIVELLO: 1</div>
            </div>
            <div class="ui-panel">
                <div id="score-display">PUNTEGGIO: 0</div>
            </div>
            <div class="ui-panel">
                <div id="special-weapon">RAZZI: 0</div>
            </div>
            <div class="ui-panel">
                <div id="combo-display">COMBO: 1x</div>
            </div>
            <div class="ui-panel">
                <div id="bitcoin-display">BITCOIN: 0</div>
            </div>
        </div>
        
        <div id="power-up-indicator" class="power-up-indicator"></div>
        <div id="bitcoin-indicator" class="bitcoin-indicator">+0.5 BITCOIN!</div>
        <div id="evolution-notification" class="evolution-notification">
            <h3>NAVICELLA EVOLUTA!</h3>
            <p id="evolution-details">La tua navicella ha raggiunto un nuovo livello!</p>
        </div>
        <div id="debug-info"></div>
        
        <div id="start-screen">
            <h1>MISSIONE SPAZIALE BITCOIN</h1>
            <p>Distruggi gli asteroidi, raccogli Bitcoin e fai evolvere la tua navicella!</p>
            
            <div class="ship-evolution">
                <div class="ship-stage">
                    <div class="ship-icon"></div>
                    <div>LIVELLO 1</div>
                    <div>0-9 BTC</div>
                </div>
                <div class="ship-stage">
                    <div class="ship-icon"></div>
                    <div>LIVELLO 2</div>
                    <div>10-19 BTC</div>
                </div>
                <div class="ship-stage">
                    <div class="ship-icon"></div>
                    <div>LIVELLO 3</div>
                    <div>20+ BTC</div>
                </div>
            </div>
            
            <button id="start-btn" class="btn">INIZIA MISSIONE</button>
            <button id="select-ship-btn" class="btn btn-ship">SELEZIONA NAVICELLA</button>
            <div class="controls-info">
                <h3>CONTROLLI</h3>
                <p>FRECCE: Muovi la navicella<br>SPAZIO: Sparare raggi<br>A: Razzi speciali</p>
            </div>
            <div class="upgrade-info">
                <h3>EVOLUZIONE AUTOMATICA</h3>
                <p>La navicella si evolve automaticamente ogni 10 Bitcoin raccolti!</p>
            </div>
        </div>
        
        <div id="ship-select-screen">
            <h2>SELEZIONA NAVICELLA</h2>
            <div>
                <div class="ship-option selected" data-ship="base">
                    <div class="ship-preview"></div>
                    <div>NAVICELLA BASE</div>
                    <div>Equilibrata</div>
                </div>
                <div class="ship-option ship-speedster" data-ship="speedster">
                    <div class="ship-preview"></div>
                    <div>VELOCISTA</div>
                    <div>+ Velocità</div>
                </div>
                <div class="ship-option ship-tank" data-ship="tank">
                    <div class="ship-preview"></div>
                    <div>CORAZZATA</div>
                    <div>+ Resistenza</div>
                </div>
                <div class="ship-option ship-sniper" data-ship="sniper">
                    <div class="ship-preview"></div>
                    <div>CECCHINO</div>
                    <div>+ Danno</div>
                </div>
            </div>
            <button id="confirm-ship-btn" class="btn">CONFERMA</button>
            <button id="back-to-menu-btn" class="btn">INDIETRO</button>
        </div>
        
        <div id="mission-screen">
            <h2>MISSIONE ATTIVA</h2>
            <div id="mission-text" class="mission-info"></div>
            <div id="mission-progress"></div>
            <button id="start-mission-btn" class="btn">INIZIA MISSIONE</button>
        </div>
        
        <div id="level-complete">
            <h2>LIVELLO COMPLETATO!</h2>
            <p id="level-complete-text">Ottimo lavoro! Passa al livello successivo.</p>
            <div class="bitcoin-summary">
                <p>Bitcoin raccolti: <span id="level-bitcoin-earned">0</span></p>
                <p>Bitcoin totali: <span id="total-bitcoin-after-level">0</span></p>
            </div>
            <button id="next-level-btn" class="btn">LIVELLO SUCCESSIVO</button>
        </div>
        
        <div id="game-over">
            <h2>MISSIONE FALLITA</h2>
            <p id="game-over-text">La tua navicella è stata distrutta!</p>
            <div class="bitcoin-summary">
                <p>Bitcoin raccolti: <span id="gameover-bitcoin-earned">0</span></p>
                <p>Punteggio: <span id="gameover-score">0</span></p>
            </div>
            <button id="restart-btn" class="btn">RIPROVA</button>
        </div>
        
        <div id="achievement-popup" class="achievement-popup">
            <h3>OBBIETTIVO SBLOCCATO!</h3>
            <p id="achievement-name"></p>
            <p id="achievement-desc"></p>
        </div>
    </div>

    <script>
        // ========== CANVAS SETUP ==========
        const canvas = document.getElementById('game-canvas');
        const ctx = canvas.getContext('2d');
        
        function resizeCanvas() {
            const container = document.getElementById('game-container');
            canvas.width = container.clientWidth;
            canvas.height = container.clientHeight;
        }
        
        resizeCanvas();
        window.addEventListener('resize', resizeCanvas);

        // ========== GAME ELEMENTS ==========
        const startScreen = document.getElementById('start-screen');
        const levelCompleteScreen = document.getElementById('level-complete');
        const gameOverScreen = document.getElementById('game-over');
        const missionScreen = document.getElementById('mission-screen');
        const shipSelectScreen = document.getElementById('ship-select-screen');
        const startBtn = document.getElementById('start-btn');
        const nextLevelBtn = document.getElementById('next-level-btn');
        const restartBtn = document.getElementById('restart-btn');
        const selectShipBtn = document.getElementById('select-ship-btn');
        const confirmShipBtn = document.getElementById('confirm-ship-btn');
        const backToMenuBtn = document.getElementById('back-to-menu-btn');
        const startMissionBtn = document.getElementById('start-mission-btn');
        const levelIndicator = document.getElementById('level-indicator');
        const scoreDisplay = document.getElementById('score-display');
        const specialWeaponDisplay = document.getElementById('special-weapon');
        const comboDisplay = document.getElementById('combo-display');
        const bitcoinDisplay = document.getElementById('bitcoin-display');
        const levelCompleteText = document.getElementById('level-complete-text');
        const gameOverText = document.getElementById('game-over-text');
        const missionText = document.getElementById('mission-text');
        const missionProgress = document.getElementById('mission-progress');
        const powerUpIndicator = document.getElementById('power-up-indicator');
        const bitcoinIndicator = document.getElementById('bitcoin-indicator');
        const evolutionNotification = document.getElementById('evolution-notification');
        const evolutionDetails = document.getElementById('evolution-details');
        const achievementPopup = document.getElementById('achievement-popup');
        const achievementName = document.getElementById('achievement-name');
        const achievementDesc = document.getElementById('achievement-desc');
        
        // ========== GAME VARIABLES ==========
        let gameActive = false;
        let currentLevel = 1;
        let score = 0;
        let rocksDestroyed = 0;
        let specialRockets = 0;
        let bitcoinCount = 0;
        let bitcoinEarnedThisLevel = 0;
        let shipLevel = 1;
        let player;
        let bullets = [];
        let specialRocketsArray = [];
        let rocks = [];
        let enemies = [];
        let powerUps = [];
        let bitcoins = [];
        let stars = [];
        let particles = [];
        let keys = {};
        let combo = 0;
        let multiplier = 1;
        let comboTimeout = null;
        let currentMission = null;
        let missionTimer = 0;
        let selectedShip = 'base';
        let gameData = {
            highScore: 0,
            levelsUnlocked: 1,
            shipsUnlocked: ['base'],
            achievements: []
        };

        // ========== SHIP TYPES ==========
        const ships = {
            base: { 
                name: 'Navicella Base',
                speed: 5, 
                fireRate: 1, 
                special: 'none',
                color: '#4a9eff',
                damage: 1
            },
            speedster: { 
                name: 'Velocista',
                speed: 7, 
                fireRate: 1.5, 
                special: 'dash',
                color: '#00ffcc',
                damage: 0.8
            },
            tank: { 
                name: 'Corazzata',
                speed: 3, 
                fireRate: 0.8, 
                special: 'shield',
                color: '#ff5555',
                damage: 1.2
            },
            sniper: { 
                name: 'Cecchino',
                speed: 4, 
                fireRate: 0.6, 
                special: 'piercing',
                color: '#cc00ff',
                damage: 2
            }
        };
        
        // ========== LEVEL CONFIGURATION ==========
        const levels = {
            1: {
                rocks: 10,
                rockHealth: 3,
                playerSpeed: 5,
                bgColor: '#0a0a2a',
                bulletSpeed: 10,
                bulletDamage: 1,
                specialRocketsUnlock: 3,
                enemies: 2,
                boss: false
            },
            2: {
                rocks: 15,
                rockHealth: 4,
                playerSpeed: 5,
                bgColor: '#0a1a2a',
                bulletSpeed: 10,
                bulletDamage: 1,
                specialRocketsUnlock: 3,
                enemies: 3,
                boss: false
            },
            3: {
                rocks: 20,
                rockHealth: 5,
                playerSpeed: 5,
                bgColor: '#1a0a2a',
                bulletSpeed: 12,
                bulletDamage: 1,
                specialRocketsUnlock: 3,
                enemies: 4,
                boss: true,
                bossType: 'alien'
            },
            4: {
                rocks: 25,
                rockHealth: 6,
                playerSpeed: 5,
                bgColor: '#1a1a2a',
                bulletSpeed: 12,
                bulletDamage: 1,
                specialRocketsUnlock: 3,
                enemies: 5,
                boss: false
            },
            5: {
                rocks: 30,
                rockHealth: 7,
                playerSpeed: 5,
                bgColor: '#2a0a1a',
                bulletSpeed: 12,
                bulletDamage: 1,
                specialRocketsUnlock: 3,
                enemies: 6,
                boss: false
            }
        };
        
        // ========== POWER-UP TYPES ==========
        const powerUpTypes = {
            shield: { 
                color: '#00aaff', 
                duration: 10000,
                effect: 'Scudo attivo!'
            },
            rapidFire: { 
                color: '#ffaa00', 
                duration: 8000,
                effect: 'Fuoco rapido!'
            },
            doublePoints: { 
                color: '#00ff00', 
                duration: 12000,
                effect: 'Punti doppi!'
            },
            freeze: { 
                color: '#00ffff', 
                duration: 6000,
                effect: 'Nemici congelati!'
            }
        };

        // ========== PLAYER CLASS ==========
        class Player {
            constructor() {
                this.shipType = selectedShip;
                this.config = ships[this.shipType];
                this.width = 40;
                this.height = 60;
                this.x = canvas.width / 2 - this.width / 2;
                this.y = canvas.height - this.height - 20;
                this.speed = this.config.speed;
                this.color = this.config.color;
                this.health = 100;
                this.maxHealth = 100;
                this.shootCooldown = 0;
                this.specialCooldown = 0;
                this.shieldActive = false;
                this.shieldTime = 0;
                this.rapidFire = false;
                this.rapidFireTime = 0;
                this.doublePoints = false;
                this.doublePointsTime = 0;
                this.freezeEnemies = false;
                this.freezeTime = 0;
                this.dashCooldown = 0;
                this.piercingShots = this.config.special === 'piercing';
            }
            
            draw() {
                ctx.fillStyle = this.shieldActive ? '#00aaff' : this.color;
                ctx.beginPath();
                
                if (shipLevel === 1) {
                    ctx.moveTo(this.x + this.width / 2, this.y);
                    ctx.lineTo(this.x + this.width, this.y + this.height / 2);
                    ctx.lineTo(this.x + this.width / 2, this.y + this.height);
                    ctx.lineTo(this.x, this.y + this.height / 2);
                } else if (shipLevel === 2) {
                    ctx.moveTo(this.x + this.width / 2, this.y);
                    ctx.lineTo(this.x + this.width, this.y + this.height / 3);
                    ctx.lineTo(this.x + this.width * 0.8, this.y + this.height);
                    ctx.lineTo(this.x + this.width / 2, this.y + this.height * 0.8);
                    ctx.lineTo(this.x + this.width * 0.2, this.y + this.height);
                    ctx.lineTo(this.x, this.y + this.height / 3);
                } else {
                    ctx.moveTo(this.x + this.width / 2, this.y);
                    ctx.lineTo(this.x + this.width, this.y + this.height / 4);
                    ctx.lineTo(this.x + this.width * 0.9, this.y + this.height / 2);
                    ctx.lineTo(this.x + this.width, this.y + this.height * 0.7);
                    ctx.lineTo(this.x + this.width * 0.7, this.y + this.height);
                    ctx.lineTo(this.x + this.width / 2, this.y + this.height * 0.9);
                    ctx.lineTo(this.x + this.width * 0.3, this.y + this.height);
                    ctx.lineTo(this.x, this.y + this.height * 0.7);
                    ctx.lineTo(this.x + this.width * 0.1, this.y + this.height / 2);
                    ctx.lineTo(this.x, this.y + this.height / 4);
                }
                
                ctx.closePath();
                ctx.fill();
                
                if (this.shieldActive) {
                    ctx.strokeStyle = 'rgba(0, 170, 255, 0.7)';
                    ctx.lineWidth = 3;
                    ctx.beginPath();
                    ctx.arc(this.x + this.width / 2, this.y + this.height / 2, this.width, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                let cockpitColor = '#aaddff';
                if (shipLevel >= 2) cockpitColor = '#ddffaa';
                if (shipLevel >= 3) cockpitColor = '#ffddaa';
                
                ctx.fillStyle = cockpitColor;
                ctx.beginPath();
                ctx.arc(this.x + this.width / 2, this.y + this.height / 2, 10, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ff5500';
                if (shipLevel === 1) {
                    ctx.fillRect(this.x + 5, this.y + this.height, this.width / 4, 10);
                    ctx.fillRect(this.x + this.width - this.width / 4 - 5, this.y + this.height, this.width / 4, 10);
                } else if (shipLevel === 2) {
                    ctx.fillRect(this.x, this.y + this.height, this.width / 5, 10);
                    ctx.fillRect(this.x + this.width / 4, this.y + this.height, this.width / 5, 10);
                    ctx.fillRect(this.x + this.width * 0.55, this.y + this.height, this.width / 5, 10);
                    ctx.fillRect(this.x + this.width * 0.8, this.y + this.height, this.width / 5, 10);
                } else {
                    ctx.fillRect(this.x, this.y + this.height, this.width / 6, 12);
                    ctx.fillRect(this.x + this.width / 5, this.y + this.height, this.width / 6, 12);
                    ctx.fillRect(this.x + this.width * 0.45, this.y + this.height, this.width / 6, 12);
                    ctx.fillRect(this.x + this.width * 0.65, this.y + this.height, this.width / 6, 12);
                    ctx.fillRect(this.x + this.width * 0.85, this.y + this.height, this.width / 6, 12);
                }
                
                if (gameActive) {
                    let flameColor = '#ffcc00';
                    if (shipLevel >= 2) flameColor = '#ffaa00';
                    if (shipLevel >= 3) flameColor = '#ff8800';
                    
                    ctx.fillStyle = flameColor;
                    if (shipLevel === 1) {
                        ctx.fillRect(this.x + 7, this.y + this.height + 10, this.width / 6, 8);
                        ctx.fillRect(this.x + this.width - this.width / 6 - 7, this.y + this.height + 10, this.width / 6, 8);
                    } else if (shipLevel === 2) {
                        ctx.fillRect(this.x + 2, this.y + this.height + 10, this.width / 7, 8);
                        ctx.fillRect(this.x + this.width / 4 + 2, this.y + this.height + 10, this.width / 7, 8);
                        ctx.fillRect(this.x + this.width * 0.55 + 2, this.y + this.height + 10, this.width / 7, 8);
                        ctx.fillRect(this.x + this.width * 0.8 + 2, this.y + this.height + 10, this.width / 7, 8);
                    } else {
                        ctx.fillRect(this.x + 2, this.y + this.height + 10, this.width / 8, 10);
                        ctx.fillRect(this.x + this.width / 5 + 2, this.y + this.height + 10, this.width / 8, 10);
                        ctx.fillRect(this.x + this.width * 0.45 + 2, this.y + this.height + 10, this.width / 8, 10);
                        ctx.fillRect(this.x + this.width * 0.65 + 2, this.y + this.height + 10, this.width / 8, 10);
                        ctx.fillRect(this.x + this.width * 0.85 + 2, this.y + this.height + 10, this.width / 8, 10);
                    }
                }
                
                if (shipLevel >= 2) {
                    ctx.fillStyle = this.color;
                    ctx.fillRect(this.x - 15, this.y + this.height / 3, 15, 5);
                    ctx.fillRect(this.x + this.width, this.y + this.height / 3, 15, 5);
                    
                    if (shipLevel >= 3) {
                        ctx.fillStyle = '#ff5555';
                        ctx.fillRect(this.x - 10, this.y + this.height / 2, 10, 5);
                        ctx.fillRect(this.x + this.width, this.y + this.height / 2, 10, 5);
                    }
                }
                
                const barWidth = 100;
                const barHeight = 10;
                const barX = this.x + this.width / 2 - barWidth / 2;
                const barY = this.y - 20;
                
                ctx.fillStyle = '#333333';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                ctx.fillStyle = this.health > this.maxHealth / 2 ? '#00ff00' : '#ff0000';
                ctx.fillRect(barX, barY, barWidth * (this.health / this.maxHealth), barHeight);
            }
            
            update() {
                let moveSpeed = this.speed;
                
                if (this.config.special === 'dash' && keys['Shift'] && this.dashCooldown === 0) {
                    moveSpeed *= 2;
                    this.dashCooldown = 60;
                }
                
                if (this.dashCooldown > 0) {
                    this.dashCooldown--;
                }
                
                if (keys['ArrowLeft'] && this.x > 0) {
                    this.x -= moveSpeed;
                }
                if (keys['ArrowRight'] && this.x < canvas.width - this.width) {
                    this.x += moveSpeed;
                }
                if (keys['ArrowUp'] && this.y > 0) {
                    this.y -= moveSpeed;
                }
                if (keys['ArrowDown'] && this.y < canvas.height - this.height) {
                    this.y += moveSpeed;
                }
                
                this.updatePowerUps();
                
                if (this.shootCooldown > 0) {
                    this.shootCooldown--;
                }
                
                if (keys[' '] && this.shootCooldown === 0) {
                    this.shoot();
                    
                    let baseCooldown = 15 - shipLevel * 2;
                    if (this.rapidFire) baseCooldown /= 2;
                    baseCooldown /= this.config.fireRate;
                    
                    this.shootCooldown = Math.max(5, Math.floor(baseCooldown));
                }
                
                if ((keys['a'] || keys['A']) && specialRockets > 0) {
                    this.shootSpecial();
                    keys['a'] = false;
                    keys['A'] = false;
                }
            }
            
            updatePowerUps() {
                if (this.shieldActive) {
                    this.shieldTime--;
                    if (this.shieldTime <= 0) {
                        this.shieldActive = false;
                        powerUpIndicator.style.display = 'none';
                    }
                }
                
                if (this.rapidFire) {
                    this.rapidFireTime--;
                    if (this.rapidFireTime <= 0) {
                        this.rapidFire = false;
                    }
                }
                
                if (this.doublePoints) {
                    this.doublePointsTime--;
                    if (this.doublePointsTime <= 0) {
                        this.doublePoints = false;
                    }
                }
                
                if (this.freezeEnemies) {
                    this.freezeTime--;
                    if (this.freezeTime <= 0) {
                        this.freezeEnemies = false;
                    }
                }
            }
            
            shoot() {
                const bulletConfig = levels[currentLevel];
                
                // Armi basate sul livello della nave
                if (shipLevel === 1) {
                    bullets.push(new Bullet(this.x + this.width / 2, this.y, bulletConfig, this.config.damage, this.piercingShots));
                } else if (shipLevel === 2) {
                    bullets.push(new Bullet(this.x + this.width / 3, this.y, bulletConfig, this.config.damage, this.piercingShots));
                    bullets.push(new Bullet(this.x + 2 * this.width / 3, this.y, bulletConfig, this.config.damage, this.piercingShots));
                } else {
                    bullets.push(new Bullet(this.x + this.width / 4, this.y, bulletConfig, this.config.damage, this.piercingShots));
                    bullets.push(new Bullet(this.x + this.width / 2, this.y, bulletConfig, this.config.damage, this.piercingShots));
                    bullets.push(new Bullet(this.x + 3 * this.width / 4, this.y, bulletConfig, this.config.damage, this.piercingShots));
                }
            }
            
            shootSpecial() {
                if (specialRockets > 0) {
                    specialRocketsArray.push(new SpecialRocket(this.x + this.width / 2, this.y));
                    specialRockets--;
                    specialWeaponDisplay.textContent = `RAZZI: ${specialRockets}`;
                    
                    for (let i = 0; i < 15; i++) {
                        particles.push(new Particle(
                            this.x + this.width / 2, 
                            this.y + this.height, 
                            '#ff5500',
                            2
                        ));
                    }
                }
            }
            
            activatePowerUp(type) {
                const powerUp = powerUpTypes[type];
                
                switch(type) {
                    case 'shield':
                        this.shieldActive = true;
                        this.shieldTime = powerUp.duration / 16.67;
                        break;
                    case 'rapidFire':
                        this.rapidFire = true;
                        this.rapidFireTime = powerUp.duration / 16.67;
                        break;
                    case 'doublePoints':
                        this.doublePoints = true;
                        this.doublePointsTime = powerUp.duration / 16.67;
                        break;
                    case 'freeze':
                        this.freezeEnemies = true;
                        this.freezeTime = powerUp.duration / 16.67;
                        break;
                }
                
                powerUpIndicator.textContent = powerUp.effect;
                powerUpIndicator.style.display = 'block';
                
                setTimeout(() => {
                    powerUpIndicator.style.display = 'none';
                }, 2000);
            }
            
            takeDamage(amount) {
                if (this.shieldActive) return false;
                
                this.health -= amount;
                if (this.health <= 0) {
                    this.health = 0;
                    gameOver();
                }
                return true;
            }
        }

        // ========== BULLET CLASS ==========
        class Bullet {
            constructor(x, y, config, damageMultiplier = 1, piercing = false, angle = 0) {
                this.x = x;
                this.y = y;
                this.width = 4 + (config.bulletDamage - 1) * 2;
                this.height = 12 + (config.bulletDamage - 1) * 3;
                this.speed = config.bulletSpeed;
                this.damage = config.bulletDamage * damageMultiplier;
                this.color = shipLevel === 1 ? '#ffcc00' : 
                             shipLevel === 2 ? '#00ffcc' : '#ff00cc';
                this.piercing = piercing;
                this.penetrated = 0;
                this.angle = angle * (Math.PI / 180);
                this.speedX = Math.sin(this.angle) * this.speed;
                this.speedY = -Math.cos(this.angle) * this.speed;
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.angle);
                
                ctx.fillStyle = this.color;
                ctx.fillRect(-this.width / 2, 0, this.width, this.height);
                
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(-1, 0, 2, 4);
                
                if (shipLevel >= 2) {
                    ctx.fillStyle = this.color;
                    ctx.beginPath();
                    ctx.arc(0, this.height, this.width / 2, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                if (shipLevel >= 3) {
                    ctx.fillStyle = '#ffffff';
                    ctx.beginPath();
                    ctx.arc(0, this.height, this.width / 4, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                ctx.restore();
            }
            
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                return this.y < 0 || this.x < 0 || this.x > canvas.width;
            }
        }

        // ========== SPECIAL ROCKET CLASS ==========
        class SpecialRocket {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.width = 12;
                this.height = 20;
                this.speed = 8;
                this.color = '#ff5500';
                this.trailParticles = [];
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.moveTo(this.x, this.y);
                ctx.lineTo(this.x - this.width / 2, this.y + this.height);
                ctx.lineTo(this.x + this.width / 2, this.y + this.height);
                ctx.closePath();
                ctx.fill();
                
                ctx.fillStyle = '#ffcc00';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.width / 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ff8800';
                ctx.fillRect(this.x - this.width, this.y + this.height / 2, this.width, 4);
                ctx.fillRect(this.x, this.y + this.height / 2, this.width, 4);
                
                for (let i = 0; i < this.trailParticles.length; i++) {
                    const p = this.trailParticles[i];
                    ctx.fillStyle = `rgba(255, ${100 + p.life * 5}, 0, ${p.life / 20})`;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                    ctx.fill();
                }
            }
            
            update() {
                this.y -= this.speed;
                
                if (Math.random() < 0.7) {
                    this.trailParticles.push({
                        x: this.x + (Math.random() - 0.5) * 10,
                        y: this.y + this.height + Math.random() * 10,
                        size: Math.random() * 3 + 1,
                        life: 20
                    });
                }
                
                for (let i = this.trailParticles.length - 1; i >= 0; i--) {
                    this.trailParticles[i].life--;
                    if (this.trailParticles[i].life <= 0) {
                        this.trailParticles.splice(i, 1);
                    }
                }
                
                return this.y < -this.height;
            }
            
            explode() {
                for (let i = 0; i < 50; i++) {
                    particles.push(new Particle(
                        this.x, 
                        this.y, 
                        '#ff5500',
                        5
                    ));
                }
                
                ctx.fillStyle = 'rgba(255, 200, 0, 0.3)';
                ctx.beginPath();
                ctx.arc(this.x, this.y, 80, 0, Math.PI * 2);
                ctx.fill();
                
                const explosionRadius = 100;
                for (let i = rocks.length - 1; i >= 0; i--) {
                    const dx = rocks[i].x - this.x;
                    const dy = rocks[i].y - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < explosionRadius + rocks[i].radius) {
                        addScore(30);
                        rocksDestroyed++;
                        
                        for (let j = 0; j < 15; j++) {
                            particles.push(new Particle(
                                rocks[i].x, 
                                rocks[i].y, 
                                '#ff9900',
                                3
                            ));
                        }
                        
                        rocks.splice(i, 1);
                    }
                }
                
                for (let i = enemies.length - 1; i >= 0; i--) {
                    const dx = enemies[i].x - this.x;
                    const dy = enemies[i].y - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < explosionRadius + enemies[i].radius) {
                        addScore(50);
                        
                        for (let j = 0; j < 15; j++) {
                            particles.push(new Particle(
                                enemies[i].x, 
                                enemies[i].y, 
                                '#ff0000',
                                3
                            ));
                        }
                        
                        enemies.splice(i, 1);
                    }
                }
                
                checkSpecialRocketsUnlock();
            }
        }

        // ========== ROCK CLASS ==========
        class Rock {
            constructor() {
                this.radius = 25 + Math.random() * 25;
                this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
                this.y = Math.random() * (canvas.height / 2) + 50;
                this.health = levels[currentLevel].rockHealth;
                this.maxHealth = this.health;
                this.color = '#663300';
                this.speedX = (Math.random() - 0.5) * 2;
                this.speedY = (Math.random() - 0.5) * 2;
                this.frozen = false;
            }
            
            draw() {
                ctx.fillStyle = this.frozen ? '#aaccff' : this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = this.frozen ? '#88aadd' : '#442200';
                ctx.beginPath();
                ctx.arc(this.x - this.radius / 3, this.y - this.radius / 4, this.radius / 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = this.frozen ? '#99bbee' : '#552200';
                ctx.beginPath();
                ctx.arc(this.x + this.radius / 4, this.y + this.radius / 3, this.radius / 3, 0, Math.PI * 2);
                ctx.fill();
                
                const barWidth = this.radius * 1.5;
                const barHeight = 5;
                const barX = this.x - barWidth / 2;
                const barY = this.y - this.radius - 10;
                
                ctx.fillStyle = '#333333';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                ctx.fillStyle = this.health > this.maxHealth / 2 ? '#00ff00' : '#ff0000';
                ctx.fillRect(barX, barY, barWidth * (this.health / this.maxHealth), barHeight);
            }
            
            update() {
                if (player.freezeEnemies) {
                    this.frozen = true;
                    return;
                }
                
                this.frozen = false;
                this.x += this.speedX;
                this.y += this.speedY;
                
                if (this.x < this.radius || this.x > canvas.width - this.radius) {
                    this.speedX *= -1;
                }
                if (this.y < this.radius || this.y > canvas.height / 2) {
                    this.speedY *= -1;
                }
            }
            
            takeDamage(damage) {
                this.health -= damage;
                if (this.health <= 0) {
                    if (Math.random() < 0.2) {
                        this.dropPowerUp();
                    }
                    if (Math.random() < 0.3) {
                        this.dropBitcoin();
                    }
                    return true;
                }
                return false;
            }
            
            dropPowerUp() {
                const types = Object.keys(powerUpTypes);
                const randomType = types[Math.floor(Math.random() * types.length)];
                powerUps.push(new PowerUp(this.x, this.y, randomType));
            }
            
            dropBitcoin() {
                bitcoins.push(new Bitcoin(this.x, this.y));
            }
        }

        // ========== BITCOIN CLASS ==========
        class Bitcoin {
            constructor(x, y) {
                this.x = x;
                this.y = y;
                this.radius = 10;
                this.speed = 2;
                this.color = '#FF9900';
                this.value = 0.5;
                this.rotation = 0;
            }
            
            draw() {
                ctx.save();
                ctx.translate(this.x, this.y);
                ctx.rotate(this.rotation);
                
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(0, 0, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#000000';
                ctx.font = 'bold 12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('₿', 0, 0);
                
                ctx.restore();
            }
            
            update() {
                this.y += this.speed;
                this.rotation += 0.1;
                return this.y > canvas.height;
            }
        }

        // ========== ENEMY CLASS ==========
        class Enemy {
            constructor(type) {
                this.type = type || this.getRandomType();
                this.radius = 20;
                this.x = Math.random() * (canvas.width - this.radius * 2) + this.radius;
                this.y = Math.random() * (canvas.height / 3) + 30;
                this.health = 3;
                this.speedX = (Math.random() - 0.5) * 2;
                this.speedY = (Math.random() - 0.5) * 2;
                this.color = this.getColor();
                this.shootCooldown = 0;
                this.frozen = false;
            }
            
            getRandomType() {
                const types = ['shooter', 'charger'];
                return types[Math.floor(Math.random() * types.length)];
            }
            
            getColor() {
                switch(this.type) {
                    case 'shooter': return '#ff0000';
                    case 'charger': return '#ff8800';
                    default: return '#ff0000';
                }
            }
            
            draw() {
                ctx.fillStyle = this.frozen ? '#aaccff' : this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = this.frozen ? '#88aadd' : '#aa0000';
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius * 0.6, 0, Math.PI * 2);
                ctx.fill();
                
                const barWidth = this.radius * 2;
                const barHeight = 4;
                const barX = this.x - barWidth / 2;
                const barY = this.y - this.radius - 8;
                
                ctx.fillStyle = '#333333';
                ctx.fillRect(barX, barY, barWidth, barHeight);
                
                ctx.fillStyle = '#00ff00';
                ctx.fillRect(barX, barY, barWidth * (this.health / 3), barHeight);
            }
            
            update() {
                if (player.freezeEnemies) {
                    this.frozen = true;
                    return;
                }
                
                this.frozen = false;
                
                switch(this.type) {
                    case 'shooter':
                        this.x += this.speedX;
                        this.y += this.speedY;
                        
                        if (this.x < this.radius || this.x > canvas.width - this.radius) {
                            this.speedX *= -1;
                        }
                        if (this.y < this.radius || this.y > canvas.height / 3) {
                            this.speedY *= -1;
                        }
                        
                        if (this.shootCooldown > 0) {
                            this.shootCooldown--;
                        } else if (Math.random() < 0.01) {
                            this.shoot();
                            this.shootCooldown = 120;
                        }
                        break;
                        
                    case 'charger':
                        const dx = player.x + player.width/2 - this.x;
                        const dy = player.y + player.height/2 - this.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance > 0) {
                            this.x += (dx / distance) * 2;
                            this.y += (dy / distance) * 2;
                        }
                        break;
                }
            }
            
            shoot() {
                // Implementazione base per proiettili nemici
            }
            
            takeDamage(damage) {
                this.health -= damage;
                return this.health <= 0;
            }
        }

        // ========== POWER-UP CLASS ==========
        class PowerUp {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.width = 20;
                this.height = 20;
                this.speed = 2;
                this.color = powerUpTypes[type].color;
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.width / 2, 0, Math.PI * 2);
                ctx.fill();
                
                ctx.fillStyle = '#ffffff';
                ctx.font = '12px Arial';
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                
                switch(this.type) {
                    case 'shield':
                        ctx.fillText('S', this.x, this.y);
                        break;
                    case 'rapidFire':
                        ctx.fillText('R', this.x, this.y);
                        break;
                    case 'doublePoints':
                        ctx.fillText('2x', this.x, this.y);
                        break;
                    case 'freeze':
                        ctx.fillText('F', this.x, this.y);
                        break;
                }
            }
            
            update() {
                this.y += this.speed;
                return this.y > canvas.height;
            }
        }

        // ========== STAR CLASS ==========
        class Star {
            constructor() {
                this.x = Math.random() * canvas.width;
                this.y = Math.random() * canvas.height;
                this.size = Math.random() * 2;
                this.speed = Math.random() * 0.5;
                this.brightness = Math.random();
            }
            
            draw() {
                ctx.fillStyle = `rgba(255, 255, 255, ${this.brightness})`;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            update() {
                this.y += this.speed;
                if (this.y > canvas.height) {
                    this.y = 0;
                    this.x = Math.random() * canvas.width;
                }
                
                this.brightness = 0.5 + Math.sin(Date.now() * 0.001 + this.x) * 0.5;
            }
        }

        // ========== PARTICLE CLASS ==========
        class Particle {
            constructor(x, y, color, sizeMultiplier = 1) {
                this.x = x;
                this.y = y;
                this.size = Math.random() * 3 * sizeMultiplier + 1;
                this.speedX = Math.random() * 6 - 3;
                this.speedY = Math.random() * 6 - 3;
                this.color = color;
                this.life = 30;
            }
            
            draw() {
                ctx.fillStyle = this.color;
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            update() {
                this.x += this.speedX;
                this.y += this.speedY;
                this.life--;
                
                return this.life <= 0;
            }
        }

        // ========== GAME FUNCTIONS ==========
        function addScore(points) {
            let actualPoints = points;
            if (player.doublePoints) actualPoints *= 2;
            if (multiplier > 1) actualPoints *= multiplier;
            
            score += actualPoints;
            scoreDisplay.textContent = `PUNTEGGIO: ${score}`;
        }

        function addBitcoin(value = 0.5) {
            const oldShipLevel = shipLevel;
            
            bitcoinCount += value;
            bitcoinEarnedThisLevel += value;
            
            // Calcola il nuovo livello della nave (ogni 10 BTC)
            shipLevel = Math.min(3, Math.floor(bitcoinCount / 10) + 1);
            
            bitcoinDisplay.textContent = `BITCOIN: ${Math.floor(bitcoinCount)}`;
            
            bitcoinIndicator.textContent = `+${value} BITCOIN!`;
            bitcoinIndicator.style.display = 'block';
            
            setTimeout(() => {
                bitcoinIndicator.style.display = 'none';
            }, 2000);
            
            // Mostra notifica evoluzione se il livello è cambiato
            if (shipLevel > oldShipLevel) {
                showEvolutionNotification(oldShipLevel, shipLevel);
            }
        }

        function showEvolutionNotification(oldLevel, newLevel) {
            evolutionDetails.textContent = `La tua navicella è passata dal livello ${oldLevel} al livello ${newLevel}! Nuove armi sbloccate.`;
            evolutionNotification.style.display = 'block';
            
            setTimeout(() => {
                evolutionNotification.style.display = 'none';
            }, 4000);
        }

        function addCombo() {
            combo++;
            
            multiplier = 1 + Math.floor(combo / 5);
            comboDisplay.textContent = `COMBO: ${multiplier}x`;
            
            clearTimeout(comboTimeout);
            comboTimeout = setTimeout(() => {
                combo = 0;
                multiplier = 1;
                comboDisplay.textContent = `COMBO: ${multiplier}x`;
            }, 3000);
        }

        function checkSpecialRocketsUnlock() {
            const rocksNeeded = levels[currentLevel].specialRocketsUnlock;
            if (rocksDestroyed >= rocksNeeded && specialRockets < 3) {
                specialRockets++;
                rocksDestroyed = 0;
                specialWeaponDisplay.textContent = `RAZZI: ${specialRockets}`;
                
                for (let i = 0; i < 20; i++) {
                    particles.push(new Particle(
                        canvas.width - 50, 
                        30, 
                        '#ff5500',
                        2
                    ));
                }
            }
        }

        function checkCollisions() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                let bulletHit = false;
                
                for (let j = rocks.length - 1; j >= 0; j--) {
                    const dx = bullets[i].x - rocks[j].x;
                    const dy = bullets[i].y - rocks[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < bullets[i].width / 2 + rocks[j].radius) {
                        if (rocks[j].takeDamage(bullets[i].damage)) {
                            addScore(10);
                            rocksDestroyed++;
                            addCombo();
                            
                            for (let k = 0; k < 10; k++) {
                                particles.push(new Particle(
                                    rocks[j].x, 
                                    rocks[j].y, 
                                    '#ff9900',
                                    2
                                ));
                            }
                            
                            rocks.splice(j, 1);
                        }
                        
                        if (!bullets[i].piercing || bullets[i].penetrated >= 2) {
                            bullets.splice(i, 1);
                            bulletHit = true;
                            break;
                        } else {
                            bullets[i].penetrated++;
                        }
                    }
                }
                
                if (!bulletHit) {
                    for (let j = enemies.length - 1; j >= 0; j--) {
                        const dx = bullets[i].x - enemies[j].x;
                        const dy = bullets[i].y - enemies[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < bullets[i].width / 2 + enemies[j].radius) {
                            if (enemies[j].takeDamage(bullets[i].damage)) {
                                addScore(20);
                                
                                for (let k = 0; k < 10; k++) {
                                    particles.push(new Particle(
                                        enemies[j].x, 
                                        enemies[j].y, 
                                        '#ff0000',
                                        2
                                    ));
                                }
                                
                                enemies.splice(j, 1);
                            }
                            
                            if (!bullets[i].piercing || bullets[i].penetrated >= 2) {
                                bullets.splice(i, 1);
                                break;
                            } else {
                                bullets[i].penetrated++;
                            }
                        }
                    }
                }
            }
            
            for (let i = specialRocketsArray.length - 1; i >= 0; i--) {
                const rocket = specialRocketsArray[i];
                
                for (let j = rocks.length - 1; j >= 0; j--) {
                    const dx = rocket.x - rocks[j].x;
                    const dy = rocket.y - rocks[j].y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < rocket.width / 2 + rocks[j].radius) {
                        rocket.explode();
                        specialRocketsArray.splice(i, 1);
                        break;
                    }
                }
                
                if (rocket.update()) {
                    specialRocketsArray.splice(i, 1);
                }
            }
            
            for (let i = rocks.length - 1; i >= 0; i--) {
                const rock = rocks[i];
                const dx = player.x + player.width/2 - rock.x;
                const dy = player.y + player.height/2 - rock.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.width/2 + rock.radius) {
                    player.takeDamage(10);
                }
            }
            
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const powerUp = powerUps[i];
                const dx = player.x + player.width/2 - powerUp.x;
                const dy = player.y + player.height/2 - powerUp.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.width/2 + powerUp.width/2) {
                    player.activatePowerUp(powerUp.type);
                    powerUps.splice(i, 1);
                } else if (powerUp.update()) {
                    powerUps.splice(i, 1);
                }
            }
            
            for (let i = bitcoins.length - 1; i >= 0; i--) {
                const bitcoin = bitcoins[i];
                const dx = player.x + player.width/2 - bitcoin.x;
                const dy = player.y + player.height/2 - bitcoin.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.width/2 + bitcoin.radius) {
                    addBitcoin(bitcoin.value);
                    bitcoins.splice(i, 1);
                } else if (bitcoin.update()) {
                    bitcoins.splice(i, 1);
                }
            }
            
            for (let i = enemies.length - 1; i >= 0; i--) {
                const enemy = enemies[i];
                const dx = player.x + player.width/2 - enemy.x;
                const dy = player.y + player.height/2 - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < player.width/2 + enemy.radius) {
                    player.takeDamage(15);
                }
            }
        }

        function checkLevelComplete() {
            if (rocks.length === 0 && enemies.length === 0) {
                levelComplete();
            }
        }

        function updateMission() {
            if (!currentMission) return;
            
            switch(currentMission.type) {
                case 'timed':
                    missionTimer--;
                    missionProgress.textContent = `Tempo rimanente: ${missionTimer} secondi - Rocce distrutte: ${rocksDestroyed}/${currentMission.target}`;
                    
                    if (missionTimer <= 0) {
                        currentMission.completed = rocksDestroyed >= currentMission.target;
                        endMission();
                    }
                    break;
                    
                case 'survival':
                    missionTimer++;
                    missionProgress.textContent = `Sopravvissuto: ${missionTimer} secondi/${currentMission.target}`;
                    
                    if (missionTimer >= currentMission.target) {
                        currentMission.completed = true;
                        endMission();
                    }
                    break;
            }
        }

        function startMission(missionId) {
            // Implementazione semplificata per missioni
            missionScreen.style.display = 'flex';
        }

        function endMission() {
            levelCompleteScreen.style.display = 'flex';
            currentMission = null;
        }

        function unlockAchievement(achievementId) {
            // Implementazione base per achievement
            achievementPopup.style.display = 'block';
            
            setTimeout(() => {
                achievementPopup.style.display = 'none';
            }, 3000);
        }

        function saveGameData() {
            localStorage.setItem('spaceGameData', JSON.stringify(gameData));
        }

        function loadGameData() {
            const saved = localStorage.getItem('spaceGameData');
            if (saved) {
                gameData = JSON.parse(saved);
            }
        }

        // ========== GAME INITIALIZATION ==========
        function initGame() {
            player = new Player();
            bullets = [];
            specialRocketsArray = [];
            rocks = [];
            enemies = [];
            powerUps = [];
            bitcoins = [];
            particles = [];
            rocksDestroyed = 0;
            bitcoinEarnedThisLevel = 0;
            
            for (let i = 0; i < levels[currentLevel].rocks; i++) {
                rocks.push(new Rock());
            }
            
            for (let i = 0; i < levels[currentLevel].enemies; i++) {
                enemies.push(new Enemy());
            }
            
            stars = [];
            for (let i = 0; i < 100; i++) {
                stars.push(new Star());
            }
            
            levelIndicator.textContent = `LIVELLO: ${currentLevel}`;
            scoreDisplay.textContent = `PUNTEGGIO: ${score}`;
            specialWeaponDisplay.textContent = `RAZZI: ${specialRockets}`;
            comboDisplay.textContent = `COMBO: ${multiplier}x`;
            bitcoinDisplay.textContent = `BITCOIN: ${Math.floor(bitcoinCount)}`;
            
            updateShipEvolutionDisplay();
        }

        function updateShipEvolutionDisplay() {
            document.querySelectorAll('.ship-stage').forEach((stage, index) => {
                if (index < shipLevel) {
                    stage.classList.add('active');
                } else {
                    stage.classList.remove('active');
                }
            });
        }

        // ========== GAME LOOP ==========
        function gameLoop() {
            if (!gameActive) return;
            
            ctx.fillStyle = levels[currentLevel].bgColor;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            stars.forEach(star => {
                star.update();
                star.draw();
            });
            
            player.update();
            player.draw();
            
            for (let i = bullets.length - 1; i >= 0; i--) {
                if (bullets[i].update()) {
                    bullets.splice(i, 1);
                } else {
                    bullets[i].draw();
                }
            }
            
            for (let i = specialRocketsArray.length - 1; i >= 0; i--) {
                if (specialRocketsArray[i].update()) {
                    specialRocketsArray.splice(i, 1);
                } else {
                    specialRocketsArray[i].draw();
                }
            }
            
            rocks.forEach(rock => {
                rock.update();
                rock.draw();
            });
            
            enemies.forEach(enemy => {
                enemy.update();
                enemy.draw();
            });
            
            powerUps.forEach(powerUp => {
                powerUp.draw();
            });
            
            bitcoins.forEach(bitcoin => {
                bitcoin.draw();
            });
            
            for (let i = particles.length - 1; i >= 0; i--) {
                if (particles[i].update()) {
                    particles.splice(i, 1);
                } else {
                    particles[i].draw();
                }
            }
            
            checkCollisions();
            checkLevelComplete();
            updateMission();
            
            requestAnimationFrame(gameLoop);
        }

        // ========== GAME STATE MANAGEMENT ==========
        function startGame() {
            gameActive = true;
            startScreen.style.display = 'none';
            missionScreen.style.display = 'none';
            initGame();
            gameLoop();
        }

        function levelComplete() {
            gameActive = false;
            
            document.getElementById('level-bitcoin-earned').textContent = Math.floor(bitcoinEarnedThisLevel);
            document.getElementById('total-bitcoin-after-level').textContent = Math.floor(bitcoinCount);
            
            currentLevel++;
            
            if (currentLevel > 5) {
                levelCompleteText.textContent = `Congratulazioni! Hai completato tutti i livelli! Punteggio finale: ${score}`;
                currentLevel = 1;
                score = 0;
                bitcoinCount = 0;
                shipLevel = 1;
            }
            
            levelCompleteScreen.style.display = 'flex';
        }

        function gameOver() {
            gameActive = false;
            
            document.getElementById('gameover-bitcoin-earned').textContent = Math.floor(bitcoinEarnedThisLevel);
            document.getElementById('gameover-score').textContent = score;
            
            if (score > gameData.highScore) {
                gameData.highScore = score;
                saveGameData();
            }
            
            gameOverText.textContent = `La tua navicella è stata distrutta!`;
            gameOverScreen.style.display = 'flex';
        }

        function nextLevel() {
            levelCompleteScreen.style.display = 'none';
            startGame();
        }

        function restartGame() {
            gameOverScreen.style.display = 'none';
            currentLevel = 1;
            score = 0;
            specialRockets = 0;
            bitcoinCount = 0;
            bitcoinEarnedThisLevel = 0;
            shipLevel = 1;
            startGame();
        }

        function selectShip() {
            startScreen.style.display = 'none';
            shipSelectScreen.style.display = 'flex';
        }

        function confirmShip() {
            shipSelectScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            updateShipEvolutionDisplay();
        }

        function backToMenu() {
            shipSelectScreen.style.display = 'none';
            startScreen.style.display = 'flex';
        }

        // ========== EVENT LISTENERS ==========
        startBtn.addEventListener('click', startGame);
        nextLevelBtn.addEventListener('click', nextLevel);
        restartBtn.addEventListener('click', restartGame);
        selectShipBtn.addEventListener('click', selectShip);
        confirmShipBtn.addEventListener('click', confirmShip);
        backToMenuBtn.addEventListener('click', backToMenu);
        startMissionBtn.addEventListener('click', startGame);

        document.querySelectorAll('.ship-option').forEach(option => {
            option.addEventListener('click', function() {
                document.querySelectorAll('.ship-option').forEach(opt => {
                    opt.classList.remove('selected');
                });
                this.classList.add('selected');
                selectedShip = this.getAttribute('data-ship');
            });
        });

        window.addEventListener('keydown', function(e) {
            keys[e.key] = true;
        });

        window.addEventListener('keyup', function(e) {
            keys[e.key] = false;
        });

        window.addEventListener('load', function() {
            loadGameData();
            resizeCanvas();
            updateShipEvolutionDisplay();
        });

        window.addEventListener('resize', function() {
            resizeCanvas();
        });

        // Inizializzazione
        initGame();
    </script>
</body>
</html>